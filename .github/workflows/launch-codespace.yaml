name: Send Issue to OpenClaw
on:
  issues:
    types: [labeled]

permissions:
  issues: write

jobs:
  dispatch:
    if: github.event.label.name == 'launch-codespace'
    runs-on: ubuntu-latest
    steps:
      - name: Install Coder CLI
        run: curl -fsSL https://coder.com/install.sh | sh

      - name: Ensure workspace exists and send task
        env:
          CODER_URL: https://noel.codespace.sh
          CODER_SESSION_TOKEN: ${{ secrets.CODER_TOKEN }}
        run: |
          WS_NAME="example-openclaw"

          # Create workspace if it doesn't exist
          if ! coder show "$WS_NAME" >/dev/null 2>&1; then
            coder create "$WS_NAME" --template example-openclaw --yes \
              --parameter cpu=4 --parameter memory=8 --parameter disk_size=50
          fi

          # Start workspace if stopped
          STATUS=$(coder show "$WS_NAME" --output json | jq -r '.latest_build.status')
          if [ "$STATUS" != "running" ]; then
            coder start "$WS_NAME" --yes
            sleep 30  # Wait for startup
          fi

          # Send task to OpenClaw via coder ssh
          coder ssh "$WS_NAME" -- openclaw agent \
            "Work on GitHub issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}. Run 'gh issue view ${{ github.event.issue.number }}' for full details. Create a branch, implement changes, and open a PR."

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `OpenClaw agent is working on this issue.\n\nWorkspace: [example-openclaw](https://noel.codespace.sh/@admin/example-openclaw)`
            });
